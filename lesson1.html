<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lesson 1 - Magic Forest</title>
    <style>
        :root {
            --primary: #8c7ae6;
            --secondary: #44bd32;
            --wood: #e1b12c;
            --danger: #ff7675;
        }

        html, body {
            width: 100%; height: 100%;
            margin: 0; padding: 0;
            overflow: hidden;
            position: fixed;
            user-select: none; -webkit-user-select: none;
            touch-action: none;
        }

        body {
            font-family: "Comic Sans MS", "Chalkboard SE", "Comic Neue", sans-serif;
            background-image: url('assets/Map.png');
            background-size: cover;
            background-position: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .overlay-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.3);
            z-index: -1;
            backdrop-filter: blur(2px);
        }

        h1 { 
            color: #2f3640; 
            text-shadow: 2px 2px #fff, 0 0 10px rgba(255,255,255,0.8); 
            margin: 10px 0 5px 0; font-size: 1.6rem; text-align: center; z-index: 10;
        }
        
        #score-board {
            position: absolute; top: 10px; right: 15px;
            background: rgba(255,255,255,0.95); padding: 5px 12px;
            border-radius: 50px; font-weight: bold; color: #fbc531;
            border: 3px solid var(--wood);
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            z-index: 100;
            display: flex; align-items: center; gap: 5px;
            font-size: 1.1rem;
        }
        #score-board img { width: 25px; height: 25px; }

        .menu-container {
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            width: 95%; max-width: 500px; z-index: 10;
        }

        .exit-btn {
            padding: 8px 20px; background: var(--danger); color: white;
            border: 3px solid #d63031; border-radius: 50px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 0 #b71540; text-decoration: none;
            display: flex; align-items: center; gap: 5px;
        }
        .exit-btn:active { transform: translateY(4px); box-shadow: none; }

        .menu-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%;
        }
        .menu-btn {
            background: rgba(255, 255, 255, 0.9); 
            border: 4px solid var(--wood);
            border-radius: 20px; padding: 10px;
            font-size: 1.1rem; cursor: pointer; color: #333;
            display: flex; flex-direction: column; align-items: center;
            transition: transform 0.1s;
            box-shadow: 0 5px 0 #c29a26;
        }
        .menu-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #c29a26; }
        .menu-icon { font-size: 2rem; margin-bottom: 5px; }

        /* RWD ÈÅäÊà≤ÂçÄÂüü */
        .game-section {
            background-image: url('assets/Gameplay Background.png');
            background-size: cover; background-position: center;
            border-radius: 20px;
            width: 96%; max-width: 600px; 
            height: 85vh; max-height: 85dvh; 
            border: 4px solid #fff;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none; flex-direction: column; align-items: center;
            position: relative; padding: 8px; box-sizing: border-box;
        }

        /* Ê©´ÂêëÊ®°ÂºèÂÑ™Âåñ */
        @media (orientation: landscape) {
            .game-section { max-width: 850px; height: 92vh; }
            .menu-container { max-width: 700px; }
            .menu-grid { grid-template-columns: repeat(4, 1fr); }
        }

        .game-content {
            background: rgba(255,255,255,0.9);
            border-radius: 15px; padding: 10px;
            width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            overflow-y: auto; box-sizing: border-box;
        }

        #guide-robot {
            position: absolute; bottom: -5px; left: -5px;
            width: 70px; height: auto;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.8));
            pointer-events: none; z-index: 50;
        }

        .back-btn {
            position: absolute; top: 10px; left: 10px;
            background: var(--danger); color: white; border: none;
            padding: 5px 12px; border-radius: 50px; cursor: pointer;
            font-size: 0.9rem; font-weight: bold;
            box-shadow: 0 3px 0 #d63031; z-index: 50;
        }
        .back-btn:active { transform: translateY(3px); box-shadow: none; }

        h2 { margin: 5px 0 5px 0; color: #2d3436; text-align: center; font-size: 1.4rem; }

        /* Level 1 */
        .big-text { font-size: 1.6rem; color: #2c3e50; margin: 15px 0; font-weight: bold; }
        #name-input { 
            font-size: 1.3rem; padding: 8px; width: 70%; 
            border: 3px solid var(--primary); border-radius: 15px; text-align: center; outline: none;
        }
        .mic-btn {
            font-size: 2.5rem; background: white; border: 3px solid #eee; border-radius: 50%;
            cursor: pointer; width: 70px; height: 70px; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1); animation: pulse 2s infinite;
        }

        /* Level 2 */
        .listen-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;
            width: 100%; flex: 1; overflow-y: auto; padding: 5px; align-content: start; 
        }
        @media (orientation: landscape) and (min-width: 600px) {
            .listen-grid { grid-template-columns: repeat(4, 1fr); align-content: center; }
        }

        .vocab-card {
            background: #fff; border-radius: 12px;
            padding: 5px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            border: 2px solid #dfe6e9; box-shadow: 0 3px 0 #b2bec3;
            transition: all 0.1s; aspect-ratio: 1/1; 
        }
        .vocab-card img { width: 85%; height: 85%; object-fit: contain; }
        .vocab-card:active { transform: translateY(3px); box-shadow: none; }
        .correct-anim { border-color: var(--secondary) !important; background: #dff9fb; animation: bounce 0.5s; }
        
        .control-panel {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; width: 100%;
            flex-shrink: 0; 
        }

        .game-btn {
            font-size: 1rem; padding: 8px 12px; 
            border: none; border-radius: 10px; color: white; cursor: pointer;
            box-shadow: 0 3px 0 rgba(0,0,0,0.2);
            flex: 1; min-width: 120px;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .game-btn:active { transform: translateY(3px); box-shadow: none; }
        .btn-primary { background: var(--primary); }
        .btn-secondary { background: var(--secondary); }
        .btn-wood { background: var(--wood); }
        .btn-danger { background: var(--danger); }

        #word-display-area {
            display: none; align-items: center; justify-content: center; gap: 10px;
            margin-bottom: 10px; font-size: 1.5rem; font-weight: bold; color: var(--primary);
        }
        #replay-word-mini {
            background: var(--primary); color: white; border: none; border-radius: 50%;
            width: 30px; height: 30px; cursor: pointer; font-size: 1rem;
            display: flex; justify-content: center; align-items: center;
        }

        /* Level 3 */
        canvas {
            border: 3px dashed var(--wood); border-radius: 10px;
            cursor: crosshair; touch-action: none; background-color: #fff;
            width: 100%; height: 200px; margin: 10px 0;
        }
        @media (orientation: landscape) { canvas { height: 160px; } }

        .letter-selector { margin-bottom: 5px; display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; }
        .letter-btn {
            font-size: 1.1rem; padding: 5px 10px;
            background: #fff; border: 2px solid var(--primary); border-radius: 8px; cursor: pointer;
            font-family: "Comic Sans MS", cursive;
        }
        .letter-btn.active { background: var(--primary); color: white; }

        /* Level 4 */
        .train-container {
            display: flex; gap: 5px; margin: 15px 0; 
            min-height: 70px; 
            background: rgba(129, 236, 236, 0.5); padding: 8px; border-radius: 12px; width: 100%;
            justify-content: center; align-items: center;
        }
        .letter-bubble {
            width: 45px; height: 45px; background: white;
            border-radius: 50%; border: 2px solid var(--wood);
            display: flex; justify-content: center; align-items: center;
            font-size: 1.4rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 3px 0 #b78e1b; color: #333;
            font-family: "Comic Sans MS", cursive;
        }
        .letter-bubble:active { transform: translateY(3px); box-shadow: none; }
        .slot { width: 45px; height: 45px; border: 2px dashed #b2bec3; border-radius: 50%; }

        /* Modal */
        #feedback-modal {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white; padding: 15px; border-radius: 20px;
            border: 5px solid var(--wood); text-align: center; z-index: 200;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 80%; max-width: 300px;
        }
        #feedback-img { width: 100px; height: auto; margin-bottom: 10px; }
        .show-modal { transform: translate(-50%, -50%) scale(1) !important; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .feedback-text { color: var(--secondary); font-size: 1.1rem; font-weight: bold; min-height: 20px; margin-top: 5px; text-align: center; }
    </style>
</head>
<body>

    <div class="overlay-bg"></div>

    <div id="score-board">
        <img src="L1/star.png" alt="Star"> 
        <span id="score">0</span>
    </div>
    
    <h1>Magic Forest</h1>

    <div id="main-menu" class="menu-container">
        <button onclick="window.location.href='index.html'" class="exit-btn">
            üö™ Back to Map
        </button>

        <div class="menu-grid">
            <button class="menu-btn" onclick="startLevel(1)">
                <div class="menu-icon">üó£Ô∏è</div>
                <div>Say Hello</div>
            </button>
            <button class="menu-btn" onclick="startLevel(2)">
                <div class="menu-icon">üëÇ</div>
                <div>Listening</div>
            </button>
            <button class="menu-btn" onclick="startLevel(3)">
                <div class="menu-icon">‚úçÔ∏è</div>
                <div>Writing</div>
            </button>
            <button class="menu-btn" onclick="startLevel(4)">
                <div class="menu-icon">üöÇ</div>
                <div>Ordering</div>
            </button>
        </div>
    </div>

    <div id="feedback-modal">
        <img id="feedback-img" src="L1/star.png">
        <h2 id="feedback-msg">Good Job!</h2>
        <button onclick="closeModal()" style="padding:8px 25px; border-radius:20px; border:none; background:var(--primary); color:white; font-size:1.1rem;">OK</button>
    </div>

    <div id="level-1" class="game-section">
        <img id="guide-robot" src="assets/guide.png">
        <button class="back-btn" onclick="goHome()">üè† Menu</button>
        <div class="game-content">
            <h2>Let's Introduce!</h2>
            <input type="text" id="name-input" placeholder="Name" value="Baby">
            <div class="big-text" id="sentence-display">Hi, I'm ________.</div>
            <button class="mic-btn" onclick="speakSentence()">üéôÔ∏è</button>
            <p>Tap mic, listen & repeat!</p>
        </div>
    </div>

    <div id="level-2" class="game-section">
        <img id="guide-robot" src="assets/guide.png">
        <button class="back-btn" onclick="goHome()">üè† Menu</button>
        <div class="game-content">
            <h2 id="listen-title">Find the Picture</h2>
            
            <div id="word-display-area">
                <span id="target-word-text">Word</span>
                <button id="replay-word-mini" onclick="playTargetWord()">üîä</button>
            </div>

            <div class="listen-grid" id="vocab-grid"></div>
            
            <div class="control-panel">
                <button id="play-word-btn" class="game-btn btn-primary" onclick="playTargetWord()">
                    üîä Play Word
                </button>
                <button id="play-sentence-btn" class="game-btn btn-secondary" onclick="playTargetSentence()" style="display:none;">
                    üó£Ô∏è Play Sentence
                </button>
                <button id="next-listen-btn" class="game-btn btn-wood" onclick="nextListeningQuestion()" style="display:none;">
                    Next ‚û°
                </button>
            </div>
        </div>
    </div>

    <div id="level-3" class="game-section">
        <button class="back-btn" onclick="goHome()">üè† Menu</button>
        <div class="game-content">
            <h2>Magic Writing</h2>
            <div class="letter-selector">
                <button class="letter-btn" onclick="setTraceLetter('A')">A</button>
                <button class="letter-btn" onclick="setTraceLetter('a')">a</button>
                <button class="letter-btn" onclick="setTraceLetter('B')">B</button>
                <button class="letter-btn" onclick="setTraceLetter('b')">b</button>
                <button class="letter-btn" onclick="setTraceLetter('C')">C</button>
                <button class="letter-btn" onclick="setTraceLetter('c')">c</button>
                <button class="letter-btn" onclick="setTraceLetter('D')">D</button>
                <button class="letter-btn" onclick="setTraceLetter('d')">d</button>
            </div>
            <canvas id="drawCanvas" width="300" height="200"></canvas>
            <div class="control-panel">
                <button onclick="clearCanvas()" class="game-btn btn-danger">üóëÔ∏è Clear</button>
                <button onclick="checkWriting()" class="game-btn btn-secondary">‚ú® Done</button>
            </div>
        </div>
    </div>

    <div id="level-4" class="game-section">
        <img id="guide-robot" src="assets/guide.png">
        <button class="back-btn" onclick="goHome()">üè† Menu</button>
        <div class="game-content">
            <h2>ABC Train</h2>
            <p>Q: <span id="q-count">1</span>/6</p>
            <div id="train-slots" class="train-container"></div>
            <div id="letter-pool" class="train-container" style="background:transparent; border:none; margin-top:5px;"></div>
            <button onclick="nextOrderQuestion()" id="next-q-btn" class="game-btn btn-wood" style="display:none; margin-top:10px;">Next ‚û°</button>
        </div>
    </div>

    <script>
        document.addEventListener('touchmove', function(e) { if (e.scale !== 1) { e.preventDefault(); } }, { passive: false });
        document.addEventListener('gesturestart', function(e) { e.preventDefault(); });

        const vocabData = [
            { word: "Apple", img: "L1/apple.png", audio: "L1/apple.mp3", sentAudio: "L1/sentence_apple.mp3" },
            { word: "Ant",   img: "L1/ant.png",   audio: "L1/ant.mp3",   sentAudio: "L1/sentence_ant.mp3" },
            { word: "Ball",  img: "L1/ball.png",  audio: "L1/ball.mp3",  sentAudio: "L1/sentence_ball.mp3" },
            { word: "Bear",  img: "L1/bear.png",  audio: "L1/bear.mp3",  sentAudio: "L1/sentence_bear.mp3" },
            { word: "Car",   img: "L1/car.png",   audio: "L1/car.mp3",   sentAudio: "L1/sentence_car.mp3" },
            { word: "Cat",   img: "L1/cat.png",   audio: "L1/cat.mp3",   sentAudio: "L1/sentence_cat.mp3" },
            { word: "Door",  img: "L1/door.png",  audio: "L1/door.mp3",  sentAudio: "L1/sentence_door.mp3" },
            { word: "Dog",   img: "L1/dog.png",   audio: "L1/dog.mp3",   sentAudio: "L1/sentence_dog.mp3" }
        ];

        let score = 0;
        let currentTargetWord = null;
        let currentOrderAnswer = [];
        let userOrderInput = [];
        let orderQCount = 0;
        let currentAudio = null;
        let isLevel2Solved = false;

        function playMp3(path) {
            if(currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            currentAudio = new Audio(path);
            currentAudio.playbackRate = 0.9; 
            currentAudio.play().catch(e => console.log("Audio play failed:", e));
        }

        // Èü≥ÊïàÊí≠Êîæ
        function playGoodJob() {
            let audio = new Audio("assets/good_job.mp3");
            audio.play().catch(() => speakRobot("Good Job!"));
        }
        function playTryAgain() {
            let audio = new Audio("assets/try_again.mp3");
            audio.play().catch(() => speakRobot("Try Again"));
        }

        const synth = window.speechSynthesis;
        function speakRobot(text) {
            if (synth.speaking) synth.cancel();
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.lang = 'en-US'; 
            utterThis.rate = 0.5; utterThis.pitch = 1.1;
            synth.speak(utterThis);
        }

        function goHome() {
            document.querySelectorAll('.game-section').forEach(el => el.style.display = 'none');
            document.getElementById('main-menu').style.display = 'flex';
            document.querySelector('.overlay-bg').style.display = 'block';
            document.body.style.backgroundImage = "url('assets/Map.png')";
            if(currentAudio) currentAudio.pause();
        }

        function startLevel(lv) {
            document.getElementById('main-menu').style.display = 'none';
            document.querySelector('.overlay-bg').style.display = 'none';
            document.body.style.backgroundImage = "none";
            const levelEl = document.getElementById(`level-${lv}`);
            levelEl.style.display = 'flex';
            
            if(lv === 1) setTimeout(() => speakRobot("What's your name?"), 800);
            if(lv === 2) initListeningGame();
            if(lv === 3) initCanvas();
            if(lv === 4) initOrderingGame();
        }

        function addScore(points) {
            score += points;
            document.getElementById('score').innerText = score;
        }

        // ‰øÆÊîπÂæåÁöÑ showModal: Â¢ûÂä†ÂèÉÊï∏ ignoreAudio (Level 2 Á≠îÂ∞çÊôÇ‰∏çÊí≠Êîæ Good Job)
        function showModal(isSuccess, msg, playAudio = true) {
            const modal = document.getElementById('feedback-modal');
            const img = document.getElementById('feedback-img');
            const txt = document.getElementById('feedback-msg');
            
            if(isSuccess) {
                if(msg.includes("Mission")) img.src = "L1/treasure chest.png"; 
                else img.src = "L1/star.png";
                
                if(playAudio) playGoodJob();
            } else {
                img.src = "assets/Encouragement.png";
                if(playAudio) playTryAgain();
            }
            txt.innerText = msg;
            modal.classList.add('show-modal');
        }

        function closeModal() {
            document.getElementById('feedback-modal').classList.remove('show-modal');
        }

        // --- Level 1: Say Hello ---
        function speakSentence() {
            const name = document.getElementById('name-input').value;
            const fullSentence = `Hi, I'm ${name}.`;
            document.getElementById('sentence-display').innerText = fullSentence;

            if (synth.speaking) synth.cancel();
            const utterThis = new SpeechSynthesisUtterance(fullSentence);
            utterThis.lang = 'en-US';
            utterThis.rate = 0.5; utterThis.pitch = 1.1;
            
            synth.speak(utterThis);
        }

        // --- Level 2: Listening (ÈÇèËºØ‰øÆÊ≠£) ---
        function initListeningGame() {
            isLevel2Solved = false;
            document.getElementById('play-sentence-btn').style.display = 'none';
            document.getElementById('next-listen-btn').style.display = 'none';
            document.getElementById('word-display-area').style.display = 'none';
            document.getElementById('play-word-btn').style.display = 'flex'; 

            const grid = document.getElementById('vocab-grid');
            grid.innerHTML = '';
            const shuffled = [...vocabData].sort(() => 0.5 - Math.random());
            const options = shuffled.slice(0, 4);
            
            currentTargetWord = options[Math.floor(Math.random() * options.length)];

            options.forEach(item => {
                const card = document.createElement('div');
                card.className = 'vocab-card';
                card.innerHTML = `<img src="${item.img}" alt="${item.word}">`;
                card.onclick = () => checkListeningAnswer(item, card);
                grid.appendChild(card);
            });

            setTimeout(() => { playTargetWord(); }, 1500);
        }

        function playTargetWord() {
            if(!currentTargetWord) return;
            playMp3(currentTargetWord.audio);
        }

        function playTargetSentence() {
            if(!currentTargetWord) return;
            playMp3(currentTargetWord.sentAudio);
        }

        function checkListeningAnswer(item, cardElement) {
            // Â¶ÇÊûúÂ∑≤Á∂ìÁ≠îÂ∞çÔºå‰∏îÈªûÊìäÁöÑÊòØ„ÄåÈùûÁ≠îÊ°à„ÄçÂç°Áâá -> ÂøµÂá∫Ë©≤Âç°ÁâáÁöÑÂñÆÂ≠ó (ÂñÆÂ≠óÈªûËÆÄÊùøÂäüËÉΩ)
            if (isLevel2Solved) {
                if(item.word !== currentTargetWord.word) {
                    playMp3(item.audio); // Êí≠ÊîæË¢´ÈªûÊìäÁöÑÈåØË™§ÂñÆÂ≠ó
                }
                return;
            }

            // Âà§Êñ∑Â∞çÈåØ
            if (item.word === currentTargetWord.word) {
                isLevel2Solved = true;
                cardElement.classList.add('correct-anim');
                
                // 1. Ë∑≥ÊòüÊòüÔºå‰ΩÜ‰∏çÊí≠ Good Job (ÂèÉÊï∏ false)
                showModal(true, "Correct!", false);
                addScore(20);

                // 2. UI ËÆäÂåñ
                document.getElementById('target-word-text').innerText = item.word;
                document.getElementById('word-display-area').style.display = 'flex'; 
                document.getElementById('play-word-btn').style.display = 'none'; 
                document.getElementById('play-sentence-btn').style.display = 'flex';
                document.getElementById('next-listen-btn').style.display = 'flex';

                // 3. Âª∂ÈÅ≤ 0.5 ÁßíÂæåÊí≠ÊîæÂè•Â≠ê
                setTimeout(() => { playTargetSentence(); }, 500);

            } else {
                // Á≠îÈåØÔºöÊí≠Êîæ„ÄåË¢´ÊåâÈåØÁöÑÈÇ£ÂÄãÂ≠ó„ÄçÁöÑËÅ≤Èü≥
                playMp3(item.audio); 
                cardElement.style.opacity = '0.5';
                // ‰∏çË∑≥Ë¶ñÁ™óÔºåÂè™ËÆìÂúñÁâáËÆäÊ∑°
            }
        }

        function nextListeningQuestion() {
            initListeningGame();
        }

        // --- Level 3: Writing ---
        let canvas, ctx, isDrawing = false;
        let currentLetter = 'A';

        function initCanvas() {
            canvas = document.getElementById('drawCanvas');
            ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            canvas.style.width = rect.width + 'px'; canvas.style.height = rect.height + 'px';

            canvas.onmousedown = startDraw; canvas.onmousemove = draw; canvas.onmouseup = stopDraw;
            canvas.ontouchstart = (e) => { e.preventDefault(); startDraw(e.touches[0]); };
            canvas.ontouchmove = (e) => { e.preventDefault(); draw(e.touches[0]); };
            canvas.ontouchend = stopDraw;

            setTraceLetter('A');
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }
        function startDraw(e) { isDrawing = true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); ctx.lineWidth = 12; ctx.lineCap = 'round'; ctx.strokeStyle = '#2d3436'; }
        function draw(e) { if (!isDrawing) return; ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); }
        function stopDraw() { isDrawing = false; }
        function clearCanvas() {
            const rect = canvas.getBoundingClientRect(); ctx.clearRect(0, 0, rect.width, rect.height);
            drawGuide(currentLetter);
        }

        function setTraceLetter(char) {
            currentLetter = char;
            document.querySelectorAll('.letter-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerText === char) btn.classList.add('active');
            });
            clearCanvas();
            const lowerChar = char.toLowerCase();
            playMp3(`L1/phonics_${lowerChar}.mp3`);
        }

        function drawGuide(char) {
            ctx.save();
            const rect = canvas.getBoundingClientRect();
            ctx.font = `${rect.height * 0.7}px "Comic Sans MS", "Chalkboard SE", sans-serif`;
            ctx.fillStyle = "#dfe6e9"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(char, rect.width/2, rect.height/2);
            ctx.restore();
        }

        function checkWriting() {
            addScore(10);
            showModal(true, "Nice Writing!");
            clearCanvas();
        }

        // --- Level 4: Ordering (ËÅ≤Èü≥‰øÆÊ≠£) ---
        function initOrderingGame() {
            orderQCount = 1;
            generateOrderQuestion();
        }

        function generateOrderQuestion() {
            if(orderQCount > 6) {
                showModal(true, "Mission Complete!");
                return;
            }
            document.getElementById('q-count').innerText = orderQCount;
            document.getElementById('next-q-btn').style.display = 'none';
            
            const startIdx = Math.floor(Math.random() * 2); 
            const isUpper = Math.random() > 0.5;
            let subset = isUpper ? ['A','B','C','D'].slice(startIdx, startIdx+3) : ['a','b','c','d'].slice(startIdx, startIdx+3);
            currentOrderAnswer = [...subset]; 
            let shuffled = [...subset].sort(() => 0.5 - Math.random());
            userOrderInput = [];
            renderOrderUI(shuffled);
        }

        function renderOrderUI(options) {
            const slots = document.getElementById('train-slots');
            const pool = document.getElementById('letter-pool');
            slots.innerHTML = ''; pool.innerHTML = '';
            for(let i=0; i<3; i++) {
                const d = document.createElement('div'); d.className = 'slot'; slots.appendChild(d);
            }
            options.forEach(char => {
                const btn = document.createElement('div');
                btn.className = 'letter-bubble'; btn.innerText = char;
                btn.onclick = () => {
                    if(userOrderInput.length < 3) {
                        userOrderInput.push(char); updateSlots();
                        btn.style.visibility = 'hidden'; checkOrder();
                        // ÊÅ¢Âæ©ÁôºÈü≥Ôºö‰ΩøÁî®Ê©üÂô®‰∫∫ÂøµÂ≠óÊØç "A" (Èùû Apple)
                        speakRobot(char);
                    }
                };
                pool.appendChild(btn);
            });
        }

        function updateSlots() {
            const slots = document.getElementById('train-slots').children;
            for(let i=0; i<slots.length; i++) {
                slots[i].innerText = userOrderInput[i] || '';
                slots[i].style.background = userOrderInput[i] ? '#fff' : 'transparent';
                slots[i].className = userOrderInput[i] ? 'letter-bubble' : 'slot';
            }
        }

        function checkOrder() {
            if(userOrderInput.length === 3) {
                const isCorrect = JSON.stringify(userOrderInput) === JSON.stringify(currentOrderAnswer);
                if(isCorrect) {
                    showModal(true, "Great!");
                    addScore(30);
                    document.getElementById('next-q-btn').style.display = 'block';
                } else {
                    showModal(false, "Try Again!");
                    setTimeout(() => {
                        userOrderInput = [];
                        const pool = document.getElementById('letter-pool');
                        Array.from(pool.children).forEach(btn => btn.style.visibility = 'visible');
                        updateSlots();
                    }, 1000);
                }
            }
        }

        function nextOrderQuestion() {
            orderQCount++;
            generateOrderQuestion();
        }
    </script>
</body>
</html>